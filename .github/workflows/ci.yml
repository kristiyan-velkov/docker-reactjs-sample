name: CI - Continuous Integration

on:
    pull_request:
        branches: [main, develop]
    push:
        branches: [main, develop]
    workflow_dispatch:

# Cancel in-progress runs for the same workflow and branch
concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

# Required permissions for all jobs
permissions:
    contents: read
    pull-requests: write
    checks: write
    security-events: write

jobs:
    # Run all CI checks in parallel
    lint:
        name: Code Quality
        uses: ./.github/workflows/lint.yml
        permissions:
            contents: read
            pull-requests: write
            checks: write
            
    test:
        name: Tests & Coverage
        uses: ./.github/workflows/test.yml
        permissions:
            contents: read
            pull-requests: write
            
    build:
        name: Build Validation
        uses: ./.github/workflows/build.yml
        permissions:
            contents: read

    security:
        name: Security Checks
        uses: ./.github/workflows/security.yml
        if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
        permissions:
            contents: read
            pull-requests: write
            security-events: write

    # Final validation step
    ci-success:
        name: CI Success
        runs-on: ubuntu-latest
        needs: [lint, test, build]
        if: always()

        steps:
            - name: Check CI Results
              run: |
                  echo "## üéØ CI Pipeline Results"
                  echo ""
                  echo "| Check | Status |"
                  echo "|-------|--------|"
                  echo "| Lint | ${{ needs.lint.result }} |"
                  echo "| Test | ${{ needs.test.result }} |"
                  echo "| Build | ${{ needs.build.result }} |"
                  echo ""

                  if [ "${{ needs.lint.result }}" = "success" ] && \
                     [ "${{ needs.test.result }}" = "success" ] && \
                     [ "${{ needs.build.result }}" = "success" ]; then
                    echo "‚úÖ All CI checks passed! Ready to merge."
                    exit 0
                  else
                    echo "‚ùå Some CI checks failed. Please fix the issues."
                    exit 1
                  fi
