name: Performance Testing

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  lighthouse:
    name: Lighthouse Performance Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build production bundle
        run: npm run build

      - name: Analyze bundle size
        run: |
          echo "## ðŸ“¦ Bundle Size Analysis"
          echo ""
          echo "### Production Build"
          du -sh dist/
          echo ""
          echo "### Asset Breakdown"
          find dist -type f -exec du -h {} + | sort -rh | head -20

      - name: Check bundle size limits
        run: |
          # Get total dist size in KB
          total_size=$(du -sk dist/ | cut -f1)
          max_size=5000  # 5MB limit

          echo "Total bundle size: ${total_size}KB"
          echo "Maximum allowed: ${max_size}KB"

          if [ $total_size -gt $max_size ]; then
            echo "âŒ Bundle size exceeds limit!"
            exit 1
          else
            echo "âœ… Bundle size within limits"
          fi

      - name: Start preview server
        run: |
          npm run preview &
          sleep 5

      - name: Wait for server
        run: |
          max_attempts=30
          attempt=0

          while [ $attempt -lt $max_attempts ]; do
            if curl -f http://localhost:4173 > /dev/null 2>&1; then
              echo "âœ… Preview server is ready"
              exit 0
            fi
            attempt=$((attempt + 1))
            echo "Waiting for preview server... (attempt $attempt/$max_attempts)"
            sleep 2
          done

          echo "âŒ Preview server failed to start"
          exit 1

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v11
        with:
          urls: |
            http://localhost:4173
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: Comment Lighthouse results on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## âš¡ Lighthouse Performance Report

            Performance audit completed! Check the artifacts for detailed results.

            ### Quick Tips
            - Aim for scores above 90 for all metrics
            - Optimize images and use modern formats (WebP, AVIF)
            - Minimize JavaScript bundle size
            - Use code splitting and lazy loading
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  bundle-analysis:
    name: Bundle Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build with stats
        run: npm run build

      - name: Analyze bundle composition
        run: |
          echo "## ðŸ“Š Bundle Composition"
          echo ""
          echo "### JavaScript Files"
          find dist -name "*.js" -type f -exec ls -lh {} \; | awk '{print $9, $5}'
          echo ""
          echo "### CSS Files"
          find dist -name "*.css" -type f -exec ls -lh {} \; | awk '{print $9, $5}'
          echo ""
          echo "### Asset Files"
          find dist -name "*.png" -o -name "*.jpg" -o -name "*.svg" -o -name "*.webp" | xargs ls -lh 2>/dev/null | awk '{print $9, $5}' || echo "No image assets found"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: production-build-${{ github.sha }}
          path: dist/
          retention-days: 7
