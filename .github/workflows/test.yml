name: Test with Docker

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]
    workflow_dispatch:

jobs:
    test:
        name: Run Tests in Docker
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build Docker development image
              run: |
                  docker build -f Dockerfile.dev -t react-app-dev .

            - name: Install dependencies in container
              run: |
                  docker run --rm react-app-dev npm ci

            - name: Run linter
              run: |
                  docker run --rm react-app-dev npm run lint

            - name: Run tests with coverage
              run: |
                  docker run --rm -v ${{ github.workspace }}/coverage:/app/coverage react-app-dev npm run test:coverage

            - name: Upload coverage reports to Codecov
              uses: codecov/codecov-action@v4
              with:
                  files: ./coverage/lcov.info
                  flags: unittests
                  name: codecov-umbrella
                  fail_ci_if_error: false
              env:
                  CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

            - name: Archive coverage results
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-report
                  path: coverage/
                  retention-days: 30

            - name: Check coverage thresholds
              run: |
                  if [ -f coverage/coverage-summary.json ]; then
                    echo "Coverage summary:"
                    cat coverage/coverage-summary.json
                  fi

    test-with-compose:
        name: Run Tests with Docker Compose
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Start services with Docker Compose
              run: |
                  docker compose up -d

            - name: Wait for services to be ready
              run: |
                  timeout 60 bash -c 'until docker compose ps | grep -q "running"; do sleep 2; done'

            - name: Run tests in compose environment
              run: |
                  docker compose exec -T web npm run test:coverage || true

            - name: Copy coverage from container
              run: |
                  docker compose cp web:/app/coverage ./coverage || true

            - name: Stop services
              run: |
                  docker compose down

            - name: Upload coverage from compose
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: coverage-compose
                  path: coverage/
                  retention-days: 30

    build-production:
        name: Build Production Image
        runs-on: ubuntu-latest
        needs: test

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build production Docker image
              run: |
                  docker build -t react-app-prod .

            - name: Test production image
              run: |
                  docker run -d -p 8080:80 --name test-container react-app-prod
                  sleep 5
                  curl -f http://localhost:8080 || exit 1
                  docker stop test-container
                  docker rm test-container

            - name: Scan image with Docker Scout
              uses: docker/scout-action@v1
              if: github.event_name == 'pull_request'
              with:
                  command: cves
                  image: local://react-app-prod
                  only-severities: critical,high
                  exit-code: false
