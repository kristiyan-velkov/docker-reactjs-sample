worker_processes auto;                          # Use all available CPU cores for maximum efficiency

# Store PID in /tmp (this directory is always writable in containers)
pid /tmp/nginx.pid;                             # Prevent permission issues inside Docker containers

events {
    worker_connections 1024;                    # Max concurrent connections per worker
}

http {
    include       /etc/nginx/mime.types;        # Load standard MIME types for correct content handling
    default_type  application/octet-stream;     # Fallback MIME type for unknown file types

    # Disable access logs to avoid permission issues and reduce output noise
    access_log off;                             # Turn off access logs completely
    error_log  /dev/stderr warn;                # Send error logs to stderr for visibility in Docker

    # Optimize static file delivery
    sendfile        on;                         # Enable efficient file transfers using kernel mechanisms
    tcp_nopush      on;                         # Optimize packet sizes when sending large files
    tcp_nodelay     on;                         # Disable buffering for low-latency responses
    keepalive_timeout  65;                      # Time to keep connections open for reuse
    keepalive_requests 1000;                    # Allow many requests per connection before closing

    # Enable gzip compression for faster load times
    gzip on;                                     # Turn on gzip compression
    gzip_types                                     # Specify which file types should be compressed
        text/plain
        text/css
        application/json
        application/javascript
        text/xml
        application/xml
        application/xml+rss
        text/javascript
        image/svg+xml;
    gzip_min_length 256;                         # Only compress responses larger than 256 bytes
    gzip_vary on;                                # Add Vary: Accept-Encoding header for proxies/CDNs

    server {
        listen       8080;                      # Expose the app on port 8080
        server_name  localhost;                 # Default server name for local setups

        # Root directory where the React build artifacts (index.html, static folder, etc.) are placed
        root /usr/share/nginx/html;             # Serve files from this directory
        index index.html;                       # Default file served on directory access

        # Main route handler — supports client-side routing in React
        location / {
            try_files $uri /index.html;         # If file is missing, fall back to index.html for SPA routing
        }

        # Cache static assets aggressively for better performance
        location ~* \.(?:ico|css|js|gif|jpe?g|png|woff2?|eot|ttf|svg|map)$ {
            expires 1y;                          # Cache for 1 year (safe for hashed filenames)
            access_log off;                      # Disable logs for static files
            add_header Cache-Control "public, immutable";  # Tell browsers that files won't change
        }

        # Additional static assets path (React’s /static/ directory)
        location /static/ {
            expires 1y;                          # Cache assets from /static for 1 year
            add_header Cache-Control "public, immutable";  # Ensure long-term caching
        }
    }
}
